# TIA 弱电流测量措施和经验汇总

本文对应的 [Github](https://github.com/Staok/thoughs-about-hardware-design)/[Gitee](https://gitee.com/staok/thoughs-about-hardware-design) 仓库地址，本文最新的原文 和 资料等等 均放在里面，发在其它地方的不会更新。



TIA 电路 用于测量弱电流（uA、nA、pA、fA 测量）。



弱信号测量，且 SMU 四象限的测量，哪一个都是需要很强的硬件积累、功底和经验，包括数学上的分析和大量不寻常的电路拓扑（可见下面 `弱信号测量开源仪表汇集`）

应对任何称为仪器的东西有着敬畏之心

是测量小信号，nV级别、pA级别

是测量大信号，如连续持续监测几千摄氏度温度

是输出小信号，如前量级

是高速采集，考虑整个链路的复杂传递函数、信息传递环节，之间的相互配合

是慢信号采集，0.1Hz以下的慢和微弱信号，调制解调法等

每一块都是特多特多的考虑、权衡、经验、发现与启发等等

应对任何称为仪器的东西有着敬畏之心



## 弱信号测量开源仪表汇集

- CERN超强开源八位半电压表HPM7177
  - [Home · Wiki · Projects / OPT-ADC-10k-32b-1cha HPM7177 · GitLab (ohwr.org)](https://ohwr.org/project/opt-adc-10k-32b-1cha/-/wikis/home)
  - [【硬核】超强八位半开源万用表-腾讯云开发者社区-腾讯云 (tencent.com)](https://cloud.tencent.com/developer/article/1798492)
- home-built-stm [Home-Built STM | Dan Berard (dberard.com)](https://dberard.com/home-built-stm/)
- Keithley吉时利源测流单元和电表仪器手册附原理图
- 安捷伦电表原理图
- nvm 开源纳伏表 [jaromir-sukuba/nvm: Open source nanovoltmeter (github.com)](https://github.com/jaromir-sukuba/nvm)
- OpenSTM-Ref-Document [Dimsmary/OpenSTM at Ref-Document (github.com)](https://github.com/Dimsmary/OpenSTM/tree/Ref-Document)
- 制作六位半数字电表源码及电路方案



## TIA 外围电路注意点

参考 `SCH & PCB 设计规范和 AD 的使用` 文中 `最基本的 PCB 绘制过程` 一节 和 `4 SCH-PCB 设计规范` 一章里面的 `本科生级` 和 `电源规范设计`、`运放设计注意 / 低噪声精密电路` 小节 等。



### 电源噪声

- DCDC到LDO之间加LC环节，LC衰减高频噪声的频带要覆盖LDO的RSRR不力的频带。
- 运放供电前加LC环节，同样的，LC衰减高频噪声的频带覆盖运放的PSRR不力的频带。
- 防止电路块之间的工地干扰，模拟部分和数字部分分别供电，分别在一点接地，进行单点接地，电路块不要串接起来。



### 电路噪声

- 电阻热噪声：不同电阻的电压和电流噪声如下。经验值，一般的100M电阻在100Hz频率约有1pA电流噪声（随着阻值减小），约有10uV电压噪声（随着阻值增大）。不同材质的电阻有不同的噪声表现，金属膜的一般相对于碳膜的较低，具体可见厂家电阻手册。并且考虑 电阻精度。

  一般电阻热噪声表格（室温 300 K）

  | 电阻值 (Ω) | 热噪声电压密度 (nV/√Hz) | 热噪声电流密度 (pA/√Hz) |
  | :--------- | :---------------------- | :---------------------- |
  | 1 kΩ       | 4.07                    | 4.07                    |
  | 10 kΩ      | 12.88                   | 1.29                    |
  | 100 kΩ     | 40.7                    | 0.407                   |
  | 1 MΩ       | 128.8                   | 0.129                   |
  | 10 MΩ      | 407                     | 0.0407                  |
  | 100 MΩ     | 1288                    | 0.0129                  |
  | 1 GΩ       | 4070                    | 0.00407                 |

- 运放的电压和电流噪声密度指标，这些噪声经过具体的运放电路连接形式放大到输出端。

  - TIA电路考虑电流噪声密度（即输入端的）应该远小于被测电流（还有Ib和Ib的温漂都应该考虑）。

  - TIA电路考虑运放电压噪声对输出的贡献，为跨阻和信号源内阻组成的电压放大电路的倍数（也即噪声增益） * 运放电压噪声密度值  * 带宽的开平方。

    对于弱电流信号源，可以认为信号源内阻是很大的，与TIA合适量程的跨阻阻值相当或更大。

  - 运放的增益带宽积（电压型运放的闭环增益和带宽的积通常为一个定值）GBW不必很大，否则噪声带宽就越大，按需。

- 信号源的噪声。

- 以上还有其它种种，合起来可估算总噪声。



### 各种隔离和防护

数模电路分离，单点接地，防共地干扰。电源树设计，多路电源分别与之供电。PCB 两个 高性能的 LDO 分别给 模拟（TIA 和 ADC 部分） 和 数字部分（如 MCU 部分） 供电，电源端，数字部分 和 模拟部分 在单点接地（不要串起来），做好防共地串扰，空间分离。

TIA 部分 + ADC 部分 独立，ADC输出数字接口 与 后面 电路 之间做 隔离（专用电磁隔离芯片、光耦等）。

对外数字接口可使用 光耦做的接口，做好对外 数字接口的 ESD 防护。

电源防护 如 瞬态抑制（TVS 管）、防反接、欠压、过压、过流 等。

输入过流保护，硬件或软件上检测到若输入超过 最大可测量电流，则关闭输入到 TIA 的连接（如 继电器），直到下次软件开机才恢复正常，这是一种模式；另一种模式是超过 最大可测量电流 的时候不管，仍继续，TIA 运放输出饱和而已，这种相比于第一种不需要重新开机而打断测量过程，但也许仍需要一个极端情况的切断保护。



成品电路板做到 批量打出来 上电就能用，不用复杂的调试等等。校准只针对随机拿出一些数量有限的电路板进行，得到的校准数据输入到新做出来的电路板上就好使。



## TIA 电路概括

### 相关书籍文献

- 系统参考书籍 《跨阻放大器设计参考》，比较全的介绍了围绕 TIA 电路的 种种。
- 还要系统参考下 吉时利的 最新《低电平测量手册》第六版。
- 芯片大厂文档，如 ADI、TI 等的。经典如：
  - 跨阻放大器电路设计和计算。
  - ADA4530、LMP7721 等芯片相关的所有技术、应用文档。
- 多看一些论文，关键字有：弱信号采集、弱电流测量，nA测量，pA测量，等，多看多思考多总结。
- CSDN 下载区里面搜索 弱电流测量 相关的文档（有些是比较珍贵的、生动真实的一手的实践经验总结，要的就是这种真实性的）。经典如：
  - 图解DIY 1pA超微电流测试器 lymex
  - 穿越电流测量的无人区——pA等级电流测量
  - 微电流测量60问答
  - 微弱电流检测放大器PCB布线布局设计-保护环介绍
  - 基于深度学习的ADI微弱信号布线指南



### 弱信号检测相关好书

- 电子电路抗干扰技术
- 弱信号检测技术. 刘国福
- 电子噪声与低噪声设计. 高晋占
- 弱信号检测. 高晋占



### 主要问题总览

- “由于模拟电路的特殊性，实际电路中的参数，元件数量等会根据每批电路的参数分布不同而有所调整，无法保证和原理图中完全一致”

  分布式参数等导致实际设备的直流误差、噪声 等。

- 微电流检测的主要障碍是：工频噪声，直流误差，直流泄漏电流。



#### 噪声

工频噪声：软硬件去除。

硬件上，双T陷波滤波器等（[《信号与系统》4.10.2工频干扰的滤除_抑制工频干扰需要什么滤波器-CSDN博客](https://blog.csdn.net/qq_32589131/article/details/105614591)）（但是占地方，且增加器件增加噪声，不值当，应当：降低系统噪声 + 软件滤波处理）。

- 硬件上，给 ADC 之前可做 压控有源二阶滤波 常规的。

软件上：平均法、滑动窗口，FIR / IIR 数字滤波 等（[如何把50Hz工频干扰定点清除-电子发烧友网 (elecfans.com)](https://www.elecfans.com/d/2096500.html)，[心电滤波(STM32)小结-CSDN博客](https://blog.csdn.net/2202_75407991/article/details/140814106)）。

- 软件上，可做 FIR 滤波，50Hz工频滤除，测量频率 以上的噪声滤除。



其它噪声：

- 建议只用电池供电来使用。纹波尽量降低。



#### 直流误差 和 校准

主要来自 运放的 Ib、Vos 以及它们的温漂等，应选择满足测量需求的运放。

对于电流测量，输入空接，测量输出，来实现自动校零。每次开机自动校零下，或依据环节变化 自动周期性调零 或 用户一键调零。（对于电压测量，就是 “差分对消”，可以硬件上可以只加个 电压采集端 的 接到 输入端 和 采集端的参考地 的 二选一切换，TIA 输入 切不可接地或接 IN+！）

各量程范围与参考源做校准，对硬件非线性、温漂、湿度等的影响做减弱（各温度、各湿度下做 每个量程选择 一个 或多个点 的校准）。

- 如 使用 吉时利 2400、2450、6517B、6220 之类的设备去校准。源表的价格原因，最终可以选择 DMM6500 或 34465（测量精度能达到 1pA） 六位半万用表来做，可以自制个恒流源发生器 用 前面的万用表来标定，然后 用这个 标定过的 自制的电流源 来给自己的设备来校准，这个思路只是想法，不一定实用。也许还得靠 专业仪表输出的弱电流源 来校准。

- 经验标明，温湿度对运放参数影响较大，尤其是高湿度环境下线路漏电流极具增加。

  因此仪器就只在室温（25℃）和寻常湿度（50%以下）进行电流的校准。

  温湿度测量若超出合适环境，则应该提醒当前温度过高或者过低，湿度过高（提示电路板应干燥 或 手动烘干），当前读数不保证准确。



减小 PCB 漏电流。目标：经验上，漏电流至少要比测量精度低一个数量级。具体看下面，从 运放选型、保护环设计、硬件配套措施等 上入手。



## 关于运放选型

下面一些双引号括起来的句子为上面参考资料里面一些拿出来的。



- 考虑上面 ”电源噪声“ 和 ”电路噪声“ 里面的描述。

- 关注 Ibias、Vos，以及同样也很重要的它们的变化范围，如 温变、随着 Vcm（共模电压）变化，以及 噪声 等。

  Vos 要低来满足测量需求，一个是降低输出误差，一个是降低保护环和输入线路的压差。

  基本要求：Vos（全温度、电源、输入共模电压范围内）<< 电压测量真实最小精度，Ib（同前，全范围内）<< 需求电流测量精度（至少小于一个数量级，更好小于两个数量级以上）。

- ADC 的输入阻抗，和信号线路的电阻形成分压，从而导致直流误差，所以 ADC 前尽量用精密运放（Vos 等要小于需求测量精度）（跟随或信号调理）输出，减少信号在传输线上的电压损失。

  ADC 选择 Sigma-Delta 类型。

- ”金属封装的芯片漏电流不如塑封的芯片低“

- “这里的性能，一般是指噪音或灵敏度。Ib 当然选小的好，但 Ib 不是极限，完全可以做出比Ib 的实际值更好的微电流测试器。极限是 Ib 的噪音。”

- “Ib 的噪音是无法克服的，例如 LMC6062 的噪音是 0.20fA、LMC6001 是 0.13fA，OPA128L 是 0.12fA，LMP7721 是 0.10fA。以上噪音的单位是√Hz，也可以认为是带宽 B=1Hz 下的噪音值。当然，这些都是噪音的典型值，通过筛选，可以取得更小的电流噪音，因此理论上在 B=1Hz 下取得 0.1fA 的噪音是完全有可能的，这已经远小于运放的 Ib 了。”



- 实际买回来芯片，主要是 运放 和 模拟开关，也许需要挑一挑，挨个试，哪个放到板子上工作更好。直接做出来试试，再换几个器件试试，都试试。



- “若被测电流变化范围极宽，不适合手动换挡的，建议选择对数放大器。搞不定交流电50Hz工频震荡干扰的，也建议选择对数放大器。”

  可以研究下对数运放，或许可以直接搞宽范围测量而不用换挡。

  不过经过检查，对数运放可能不好选择 Ib 极低 的选型。而且，把很宽的输入范围比如跨8个数量级分在可能0.2V~1.6V之间，对于ADC的有效测量精度有较高要求。

  

## 关于 TIA 反馈网络

- 选择大电阻，而不是 T网络 接法。

  “用 T 型网络后电阻是降下来了，但带来的问题就是电流噪音相应的增大。正规的微电流计没有一个采用 T 型网络的。纵观商品的静电计/微电流计，都是采用大电阻的方式，一般都用到100G，更有吉时利的642和6430，用到了1T，这样才能取得0.08fA的噪音有效值和0.4fA峰峰值（有效值和峰峰值一般是 5 倍的关系）。”

- 跨阻 Rf 应靠近运放的 IN-；Vout 从 Rf 出。加入保护环。具体可以看 ADA4530 和 LMP7721 等芯片的有关手册里面的 推荐 PCB 图。

- 跨阻 Rf 并联的 Cf 根据闭环稳定性要求 有 最小值。

  具体计算看 经典文档如 `跨阻放大器电路设计和计算` 或 书籍 《跨阻放大器设计参考》。整 TIA 电路噪声也可以计算预估。

- 输入线路尽量短，减少漏电流。

- 各 RC 环节，依 需求 采集速率 来确定。



- 在仿真软件里面跑一跑，可 TINA-TI 或 LTspice，放上实际选用的芯片型号。

  看一看 各种性能指标，伯德图，相位裕量，噪声功率谱图，噪声功率密度 等



## 保护环

- 保护环 的 PCB 布局应包裹整个输入到 IN- 有关的所有线路。弱有多层板，保护环应在多层电路板都把输入线路整个都包裹住。具体可以看 ADA4530 和 LMP7721 等芯片的有关手册里面的 推荐 PCB 图。
- 保护环应尽量使得 输入电流 的线路 到 TIA 电路 上的 漏电流 小于 测量精度 一个数量级。
- 减小保护环（Guard Ring）与信号线的电压差。
- 保护环保持低的阻抗，至少要比信号线上阻抗更低，让外围漏电流往保护环上漏而不是信号线。保护环由运放 IN+ 经过跟随运放（选择尽量低的 Vos 的精密运放）再串入1K 电阻 来驱动。
- 保护环不应该带载，带载会拉起其电压从而与被保护线路的电压形成客观压差而造成被保护电路漏电流。若需要带载则需要使用输出电阻更低（输出能力更强）的跟随运放做驱动。
- 参考 ADA4530 手册中的 PCB，其中 ”高阻抗走线和保护走线移除了阻焊层，确保保护环与所有表面漏电流路径形成电气接触。基于同样的原因，应避免在此部分中印刷丝网。“



## 硬件配套措施

“在测量1uA以下电流，尤其是近1nA电流时，由于电流极低，空气湿度，灰尘，电路板洁净程度，电路板所处的电磁环境，电路板自身的体电阻等均会对测量产生很大的影响，尤其是工频震荡问题，使用者必须对这些有一定程度的了解，才有可能发挥到最佳性能。”

### 关于清洁

- 敏感信号 PCB 上不要有喷墨字符等干扰物。

- 敏感信号附近，不要使用助焊膏。

- 清洁后烘烤以消除吸收的湿气。

  ”湿度水平较高 (>60%) 时，有效输入偏置电流幅度变得对相对湿度非常敏感。漏电流幅度迅速提高（两个数量级，fA到100fA），且极性可能改变“

- 板材保持清洁，增加板材上的绝缘电阻；避免污染物接触信号区域。电路板密封，防止吸湿导致绝缘下降；控制湿度（<30% RH）。



- PCB 表面 涂敷三防漆，比卖你水汽、灰尘等的侵入。注意三防漆的绝缘性。

### PCB 材质

- PCB材料建议使用专用于射频微波电路的瓷片薄片，具有的高阻抗，优秀介电系数（尤其是对于pA和亚pA级别测量电路）。

  ”Rogers 4350B是一种设计用于射频/微波电路的陶瓷薄片。经测试，该材料在不到20秒时间内便可将介电弛豫电流耗散到1 fA以下。“

  ”玻璃环氧树脂薄片需要1小时才能将介电弛豫电流耗散到10 fA以下。这表明，玻璃环氧树脂薄片不适合用于高性能静电计电路。“



- 根据 板材绝缘电阻 和 信号线与保护环电压差，可以估算漏电流，应小于 10% 测量精度，即小于需求测量精度一个数量级。

### 电路屏蔽壳

- 电磁笼防护壳，不仅屏蔽一些外来电磁干扰，也遮光，防止光照在敏感电路引起一些半导体器件的光电反应引起的电流。
- 避免外界有复杂的电磁环境，以及震动等。
- TIA电路部分可以焊接金属屏蔽罩封起来，防电磁干扰，也防湿度过大等。当然 温湿度传感器 芯片 就放在 此 旁边。



### 输入连接

- 可使用 BNC 接口 输入被测电流，电流输入端 到 TIA 尽量短短短以减少漏电流！可尝试在 1cm 以内。

- 电流输入使用三同轴电缆，BNC 接口，线缆的中心走输入电流，中层连接保护环 Guard Ring 电位，外层走输入电流的地。

  实际调查，BNC 三同轴 的接口 和 线缆比 二同轴 的贵很多（5倍以上）。按需吧。若测量 pA 以及 亚 pA 级别的，这种级别仪表本身也不便宜，这个接口和线缆成本也就占个零头了。

- 线缆进来的输入电流和地，直连测量端的查分输入，注意这个差分线两条线到测量端要阻抗一致。传感器端单端输出时的地与测量端的前端运放的地连接，注意防止共地干扰

- “商品的微电流测试设备不仅禁止在测试中晃动电缆，而且电缆都是特殊材料制作的，以便减少压电和摩擦生电效应，而且电缆都做成很硬的那种，使其对气流和振动不敏感。”